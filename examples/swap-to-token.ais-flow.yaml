schema: "ais-flow/0.0.3"

meta:
  name: "swap-to-token"
  version: "0.0.3"
  description: "Quote then swap using Uniswap V3 exact-in"

default_chain: "eip155:1"

requires_pack:
  name: "safe-defi-pack"
  version: "0.0.2"

imports:
  protocols:
    - { protocol: "uniswap-v3@0.0.2", path: "examples/uniswap-v3.ais.yaml" }

# ═══════════════════════════════════════════════════════════════════════════════
# INPUTS
# ═══════════════════════════════════════════════════════════════════════════════

inputs:
  token_in:
    type: asset
    required: true

  token_out:
    type: asset
    required: true

  amount_in:
    type: token_amount
    required: true

  slippage_bps:
    type: uint32
    required: true
    default: "50"

  recipient:
    type: address
    required: false

# ═══════════════════════════════════════════════════════════════════════════════
# NODES
# ═══════════════════════════════════════════════════════════════════════════════

nodes:
  - id: q_quote
    type: query_ref
    protocol: "uniswap-v3@0.0.2"
    query: "quote-exact-in-single"
    args:
      token_in: { ref: "inputs.token_in" }
      token_out: { ref: "inputs.token_out" }
      amount_in: { ref: "inputs.amount_in" }
      fee: { lit: null }

  - id: q_allowance
    type: query_ref
    protocol: "uniswap-v3@0.0.2"
    query: "allowance-token-in"
    args:
      token_in: { ref: "inputs.token_in" }

  - id: a_swap
    type: action_ref
    protocol: "uniswap-v3@0.0.2"
    action: "swap-exact-in"
    args:
      token_in: { ref: "inputs.token_in" }
      token_out: { ref: "inputs.token_out" }
      amount_in: { ref: "inputs.amount_in" }
      slippage_bps: { ref: "inputs.slippage_bps" }
      fee: { ref: "nodes.q_quote.outputs.fee_tier" }
      recipient: { ref: "inputs.recipient" }
    calculated_overrides:
      min_out_atomic:
        expr: { cel: "mul_div(nodes.q_quote.outputs.amount_out_atomic, (10000 - inputs.slippage_bps), 10000)" }
    deps: ["q_quote", "q_allowance"]

# ═══════════════════════════════════════════════════════════════════════════════
# POLICY
# ═══════════════════════════════════════════════════════════════════════════════

policy:
  approvals:
    use_pack_defaults: true

  hard_constraints:
    tighten_only: true
    max_slippage_bps: { ref: "inputs.slippage_bps" }

# ═══════════════════════════════════════════════════════════════════════════════
# PREFLIGHT
# ═══════════════════════════════════════════════════════════════════════════════

preflight:
  simulate:
    evm_eth_call: true
    debug_call: false

# ═══════════════════════════════════════════════════════════════════════════════
# OUTPUTS
# ═══════════════════════════════════════════════════════════════════════════════

outputs:
  expected_amount_out_atomic: { ref: "nodes.q_quote.outputs.amount_out_atomic" }
  min_out_atomic: { ref: "nodes.a_swap.calculated.min_out_atomic" }
  action_tx: { ref: "nodes.a_swap.tx" }
