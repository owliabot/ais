schema: "ais/0.0.2"

meta:
  protocol: "spl-token"
  version: "0.0.2"
  name: "SPL Token"
  homepage: "https://spl.solana.com/token"
  description: "SPL Token transfer with idempotent ATA creation"
  tags: ["token", "transfer", "solana"]
  maintainer: "solana.labs"

capabilities_required:
  - "cel_v1"
  - "solana_instruction"
  - "cel_builtin:derive_ata"

deployments:
  - chain: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp" # Mainnet
    contracts:
      token_program: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
      ata_program: "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"
      system_program: "11111111111111111111111111111111"

supported_assets:
  - symbol: "SOL"
    name: "Wrapped SOL"
    decimals:
      solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp: 9
    addresses:
      solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp: "So11111111111111111111111111111111111111112"
    tags: ["native", "wrapped"]

  - symbol: "USDC"
    name: "USD Coin"
    decimals:
      solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp: 6
    addresses:
      solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
    tags: ["stable"]

risks:
  - level: "info"
    text: "Transfers require the destination to have an ATA. This spec uses create_idempotent to ensure it exists."
    applies_to: ["transfer"]

actions:
  transfer:
    description: "Transfer SPL tokens; creates destination ATA idempotently."
    risk_level: 2
    risk_tags: ["transfer"]

    params:
      - name: token
        type: asset
        description: "Token mint"
      - name: amount
        type: token_amount
        description: "Human amount"
        asset_ref: "token"
      - name: recipient
        type: address
        description: "Recipient wallet (not ATA)"

    calculated_fields:
      amount_atomic:
        expr: { cel: "to_atomic(params.amount, params.token)" }
        inputs: ["params.amount", "params.token"]
      sender_ata:
        expr: { cel: "derive_ata(ctx.wallet_address, params.token.address)" }
        inputs: ["ctx.wallet_address", "params.token"]
      recipient_ata:
        expr: { cel: "derive_ata(params.recipient, params.token.address)" }
        inputs: ["params.recipient", "params.token"]

    execution:
      "solana:*":
        type: composite
        steps:
          - id: create_recipient_ata
            description: "Create recipient ATA (idempotent)"
            execution:
              type: solana_instruction
              program: { ref: "contracts.ata_program" }
              instruction: "create_idempotent"
              discriminator: { lit: "0x01" }
              accounts:
                - name: payer
                  pubkey: { ref: "ctx.wallet_address" }
                  signer: { lit: true }
                  writable: { lit: true }
                - name: associated_token
                  pubkey: { ref: "calculated.recipient_ata" }
                  signer: { lit: false }
                  writable: { lit: true }
                - name: owner
                  pubkey: { ref: "params.recipient" }
                  signer: { lit: false }
                  writable: { lit: false }
                - name: mint
                  pubkey: { ref: "params.token.address" }
                  signer: { lit: false }
                  writable: { lit: false }
                - name: system_program
                  pubkey: { ref: "contracts.system_program" }
                  signer: { lit: false }
                  writable: { lit: false }
                - name: token_program
                  pubkey: { ref: "contracts.token_program" }
                  signer: { lit: false }
                  writable: { lit: false }
              data:
                object: {}
              compute_units: { lit: "30000" }

          - id: transfer
            description: "SPL Token transfer"
            execution:
              type: solana_instruction
              program: { ref: "contracts.token_program" }
              instruction: "transfer"
              discriminator: { lit: "0x03" }
              accounts:
                - name: source
                  pubkey: { ref: "calculated.sender_ata" }
                  signer: { lit: false }
                  writable: { lit: true }
                - name: destination
                  pubkey: { ref: "calculated.recipient_ata" }
                  signer: { lit: false }
                  writable: { lit: true }
                - name: authority
                  pubkey: { ref: "ctx.wallet_address" }
                  signer: { lit: true }
                  writable: { lit: false }
              data:
                object:
                  amount: { ref: "calculated.amount_atomic" }
              compute_units: { lit: "10000" }

