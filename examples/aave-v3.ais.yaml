schema: "ais/0.0.2"

meta:
  protocol: "aave-v3"
  version: "0.0.2"
  name: "Aave V3"
  homepage: "https://aave.com"
  description: "Decentralized lending protocol (supply/withdraw subset)"
  tags: ["lending", "borrowing", "yield", "defi"]
  maintainer: "aave.eth"

capabilities_required:
  - "cel_v1"
  - "evm_read"
  - "evm_call"

deployments:
  - chain: "eip155:1"
    contracts:
      pool: "0x87870Bca3F3fD6335C3F4ce8392D69350B4fA4E2"

  - chain: "eip155:8453"
    contracts:
      pool: "0xA238Dd80C259a72e81d7e4664a9801593F98d1c5"

  - chain: "eip155:42161"
    contracts:
      pool: "0x794a61358D6845594F94dc1DB02A252b5b4814aD"

supported_assets:
  - symbol: "WETH"
    name: "Wrapped Ether"
    decimals:
      eip155:1: 18
      eip155:8453: 18
      eip155:42161: 18
    addresses:
      eip155:1: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
      eip155:8453: "0x4200000000000000000000000000000000000006"
      eip155:42161: "0x82aF49447D8a07e3bd95BD0d56f35241523fBab1"
    tags: ["wrapped", "collateral"]

  - symbol: "USDC"
    name: "USD Coin"
    decimals:
      eip155:1: 6
      eip155:8453: 6
      eip155:42161: 6
    addresses:
      eip155:1: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"
      eip155:8453: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
      eip155:42161: "0xaf88d065e77c8cC2239327C5EDb3A432268e5831"
    tags: ["stable", "collateral"]

risks:
  - level: "warning"
    text: "Withdrawing collateral can reduce health factor and may lead to liquidation if debt exists."
    applies_to: ["withdraw"]

actions:
  supply-raw:
    description: "Supply tokens to Aave pool (raw; expects atomic amount; no composite/auto-approve)."
    risk_level: 3
    risk_tags: ["approval", "custody"]

    params:
      - name: token
        type: asset
        description: "Token asset to supply"
        required: true
      - name: amount_atomic
        type: uint256
        description: "Atomic amount to supply"
        required: true
      - name: on_behalf_of
        type: address
        required: false
        description: "Credit recipient (defaults to sender)"

    execution:
      "eip155:*":
        type: evm_call
        to: { ref: "contracts.pool" }
        abi:
          type: "function"
          name: "supply"
          inputs:
            - { name: "asset", type: "address" }
            - { name: "amount", type: "uint256" }
            - { name: "onBehalfOf", type: "address" }
            - { name: "referralCode", type: "uint16" }
          outputs: []
        args:
          asset: { ref: "params.token.address" }
          amount: { ref: "params.amount_atomic" }
          onBehalfOf: { cel: "params.on_behalf_of != null ? params.on_behalf_of : ctx.wallet_address" }
          referralCode: { lit: "0" }

  borrow-raw:
    description: "Borrow tokens from Aave pool (raw; expects atomic amount)."
    risk_level: 4
    risk_tags: ["borrow", "debt"]

    params:
      - name: token
        type: asset
        description: "Token asset to borrow"
        required: true
      - name: amount_atomic
        type: uint256
        description: "Atomic amount to borrow"
        required: true
      - name: interest_rate_mode
        type: uint8
        required: false
        description: "1=stable, 2=variable (defaults to 2)"
      - name: on_behalf_of
        type: address
        required: false
        description: "Debt recipient (defaults to sender)"

    execution:
      "eip155:*":
        type: evm_call
        to: { ref: "contracts.pool" }
        abi:
          type: "function"
          name: "borrow"
          inputs:
            - { name: "asset", type: "address" }
            - { name: "amount", type: "uint256" }
            - { name: "interestRateMode", type: "uint256" }
            - { name: "referralCode", type: "uint16" }
            - { name: "onBehalfOf", type: "address" }
          outputs: []
        args:
          asset: { ref: "params.token.address" }
          amount: { ref: "params.amount_atomic" }
          interestRateMode: { cel: "params.interest_rate_mode != null ? params.interest_rate_mode : 2" }
          referralCode: { lit: "0" }
          onBehalfOf: { cel: "params.on_behalf_of != null ? params.on_behalf_of : ctx.wallet_address" }

  supply:
    description: "Supply (deposit) tokens to earn interest and optionally use as collateral."
    risk_level: 2
    risk_tags: ["approval"]

    params:
      - name: token
        type: asset
        description: "Token asset to supply"
      - name: amount
        type: token_amount
        description: "Human amount to supply"
        asset_ref: "token"
      - name: on_behalf_of
        type: address
        required: false
        description: "Credit recipient (defaults to sender)"

    requires_queries:
      - "allowance-token"

    hard_constraints:
      allow_unlimited_approval: { lit: false }

    calculated_fields:
      amount_atomic:
        expr: { cel: "to_atomic(params.amount, params.token)" }
        inputs: ["params.amount", "params.token"]
      recipient:
        expr: { cel: "params.on_behalf_of != null ? params.on_behalf_of : ctx.wallet_address" }
        inputs: ["params.on_behalf_of", "ctx.wallet_address"]

    execution:
      "eip155:*":
        type: composite
        steps:
          - id: approve_if_needed
            description: "Approve pool to spend token if allowance insufficient"
            condition: { cel: "query[\"allowance-token\"].allowance_atomic < calculated.amount_atomic" }
            execution:
              type: evm_call
              to: { ref: "params.token.address" }
              abi:
                type: "function"
                name: "approve"
                inputs:
                  - { name: "spender", type: "address" }
                  - { name: "amount", type: "uint256" }
                outputs: []
              args:
                spender: { ref: "contracts.pool" }
                amount: { ref: "calculated.amount_atomic" }

          - id: supply
            description: "Supply tokens to Aave pool"
            execution:
              type: evm_call
              to: { ref: "contracts.pool" }
              abi:
                type: "function"
                name: "supply"
                inputs:
                  - { name: "asset", type: "address" }
                  - { name: "amount", type: "uint256" }
                  - { name: "onBehalfOf", type: "address" }
                  - { name: "referralCode", type: "uint16" }
                outputs: []
              args:
                asset: { ref: "params.token.address" }
                amount: { ref: "calculated.amount_atomic" }
                onBehalfOf: { ref: "calculated.recipient" }
                referralCode: { lit: "0" }

  withdraw:
    description: "Withdraw supplied tokens from Aave."
    risk_level: 2
    risk_tags: ["custody"]

    params:
      - name: token
        type: asset
        description: "Token to withdraw (underlying, not aToken)"
      - name: amount
        type: token_amount
        description: "Human amount to withdraw (use 'max' for all)"
        asset_ref: "token"
      - name: recipient
        type: address
        required: false
        description: "Recipient of withdrawn tokens (defaults to sender)"

    calculated_fields:
      amount_atomic:
        expr: { cel: "params.amount == 'max' ? MAX_UINT256 : to_atomic(params.amount, params.token)" }
        inputs: ["params.amount", "params.token"]
      recipient:
        expr: { cel: "params.recipient != null ? params.recipient : ctx.wallet_address" }
        inputs: ["params.recipient", "ctx.wallet_address"]

    execution:
      "eip155:*":
        type: evm_call
        to: { ref: "contracts.pool" }
        abi:
          type: "function"
          name: "withdraw"
          inputs:
            - { name: "asset", type: "address" }
            - { name: "amount", type: "uint256" }
            - { name: "to", type: "address" }
          outputs: []
        args:
          asset: { ref: "params.token.address" }
          amount: { ref: "calculated.amount_atomic" }
          to: { ref: "calculated.recipient" }

queries:
  allowance-token:
    description: "Read token allowance for Aave pool"
    params:
      - name: token
        type: asset
        description: "Token asset"

    returns:
      - name: allowance_atomic
        type: uint256

    cache_ttl: 10
    execution:
      "eip155:*":
        type: evm_read
        to: { ref: "params.token.address" }
        abi:
          type: "function"
          name: "allowance"
          inputs:
            - { name: "owner", type: "address" }
            - { name: "spender", type: "address" }
          outputs:
            - { name: "allowance_atomic", type: "uint256" }
        args:
          owner: { ref: "ctx.wallet_address" }
          spender: { ref: "contracts.pool" }
